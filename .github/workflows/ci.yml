name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-test:
    name: ${{ matrix.label }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - label: linux-py311
            os: ubuntu-latest
            python-version: "3.11"
            rust-features: "python-bindings,simd,opencv"
            python-features: "python-bindings,simd,opencv"
            precommit: true
          - label: linux-py312
            os: ubuntu-latest
            python-version: "3.12"
            rust-features: "python-bindings,simd,opencv"
            python-features: "python-bindings,simd,opencv"
            precommit: false
          - label: macos
            os: macos-latest
            python-version: "3.11"
            rust-features: "python-bindings,simd,opencv,metal"
            python-features: "python-bindings,simd,opencv,metal"
            precommit: false
          - label: windows
            os: windows-latest
            python-version: "3.11"
            rust-features: "python-bindings,simd,opencv"
            python-features: "python-bindings,simd,opencv"
            precommit: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config clang libclang-dev llvm-dev cmake ninja-build libopencv-dev python3-opencv
          echo "LLVM_CONFIG_PATH=$(command -v llvm-config)" >> "$GITHUB_ENV"
          echo "LIBCLANG_PATH=$(llvm-config --libdir)" >> "$GITHUB_ENV"

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          brew update
          brew install opencv llvm ninja
          LLVM_PREFIX="$(brew --prefix llvm)"
          OPENCV_PREFIX="$(brew --prefix opencv)"
          echo "LIBCLANG_PATH=${LLVM_PREFIX}/lib" >> "$GITHUB_ENV"
          echo "LLVM_CONFIG_PATH=${LLVM_PREFIX}/bin/llvm-config" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_PATH=${OPENCV_PREFIX}/lib/pkgconfig:$PKG_CONFIG_PATH" >> "$GITHUB_ENV"
          echo "OPENCV_LINK_PATHS=${OPENCV_PREFIX}/lib" >> "$GITHUB_ENV"
          echo "OPENCV_INCLUDE_PATHS=${OPENCV_PREFIX}/include/opencv4" >> "$GITHUB_ENV"

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          choco install -y ninja llvm opencv
          $llvmBin = 'C:\\Program Files\\LLVM\\bin'
          if (-not (Test-Path $llvmBin)) { throw "LLVM not found at $llvmBin" }
          Add-Content -Path $env:GITHUB_ENV -Value "LIBCLANG_PATH=$llvmBin"
          Add-Content -Path $env:GITHUB_ENV -Value "LLVM_CONFIG_PATH=$llvmBin\\llvm-config.exe"
          $opencvDir = 'C:\\tools\\opencv\\build'
          if (-not (Test-Path $opencvDir)) { throw "OpenCV not found at $opencvDir" }
          $libDir = Join-Path $opencvDir 'x64\\vc16\\lib'
          $includeDir = Join-Path $opencvDir 'include'
          $worldLib = Get-ChildItem $libDir -Filter 'opencv_world*.lib' | Select-Object -First 1
          if (-not $worldLib) { throw "Unable to locate opencv_world*.lib under $libDir" }
          $libName = [System.IO.Path]::GetFileNameWithoutExtension($worldLib.Name)
          Add-Content -Path $env:GITHUB_ENV -Value "OPENCV_DIR=$opencvDir"
          Add-Content -Path $env:GITHUB_ENV -Value "OPENCV_LINK_PATHS=$libDir"
          Add-Content -Path $env:GITHUB_ENV -Value "OPENCV_INCLUDE_PATHS=$includeDir"
          Add-Content -Path $env:GITHUB_ENV -Value "OPENCV_LINK_LIBS=$libName"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.89
          components: rustfmt, clippy

      - name: Cache cargo build data
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Python tooling
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ "${RUNNER_OS}" = "Linux" ]; then
            pip install "maturin[patchelf]" pytest pytest-benchmark numpy pillow opencv-python pre-commit
          else
            pip install maturin pytest pytest-benchmark numpy pillow opencv-python pre-commit
          fi

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --no-default-features --features "${{ matrix.rust-features }}" -- -D warnings

      - name: Run cargo tests
        run: cargo test --no-default-features --features "${{ matrix.rust-features }}"

      - name: Build Python extension
        shell: bash
        run: maturin develop --release --no-default-features --features "${{ matrix.python-features }}"

      - name: Run pytest
        shell: bash
        run: pytest tests -v

      - name: Run pre-commit checks
        if: matrix.precommit == true
        shell: bash
        run: pre-commit run --all-files

  logs-download:
    name: Download GH action logs
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.1
      - name: Download 24hrs Old Logs
        uses: pawanbahuguna/action-logs@v2.0.0
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_REPO: ${{ github.repository }}
